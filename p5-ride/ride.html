<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.2/p5.js"></script>
    <style>
        body, html {
            margin: 0;
        }
    </style>
    <script>

    let halfWidth, halfHeight;
    let dataReady = false;

    let globalData = [];
    let starPositions;

    // let start = [40.748416, -73.9856605];
    // let end = [37.8113798, -122.4773046];

    let start = [45.679605, -111.049531];
    let end = [44.475066, -110.666146];


    function generateUrl(start, end, offset=0, samples=500) {

        start = `${start[0] + offset},${start[1] + offset}`;
        end = `${end[0] + offset},${end[1] + offset}`;

        start = start.replace(",", "%2C");
        end = end.replace(",", "%2C");
        return (
            `https://query.yahooapis.com/v1/public/yql?q=` +
            `select%20*%20from%20json%20where%20url%3D'` +
            `https%3A%2F%2Fmaps.google.com%2Fmaps%2Fapi%2Felevation%2Fjson` +
            `%3Fpath%3D${start}%257C${end}%26samples%3D${samples}'` + `&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys`
        );
    }


    Promise.all([
        fetch(generateUrl(start, end)),
        fetch(generateUrl(start, end, offset=0.01)),
        fetch(generateUrl(start, end, offset=0.02)),
        fetch(generateUrl(start, end, offset=0.05)),
        fetch(generateUrl(start, end, offset=0.5)),
        fetch(generateUrl(start, end, offset=0.6)),
        fetch(generateUrl(start, end, offset=0.7))
    ]).then(vals => {
        vals.forEach(v => v.json().then(data => {
            globalData.push(data.query.results.json.results);
        }));
        dataReady = true;
    })
    // fetch(generateUrl(start, end))
    // .then(res => res.json())
    // .then(data => {
    //     globalData.push( data.query.results.json.results);
    //     fetch(generateUrl(start, end, offset=1))
    //     .then(res => res.json())
    //     .then(data => {
    //         globalData.push(data.query.results.json.results);
    //         fetch(generateUrl(start, end, offset=3))
    //         .then(res => res.json())
    //         .then(data => {
    //             globalData.push(data.query.results.json.results);
    //             dataReady = true;
    //         });
    //     });
    // });

    function setup() {
        createCanvas(windowWidth, windowHeight);
        let starRadius = max(windowWidth, windowHeight);
        starPositions = [...Array(300)].map(i => {
            return [
                Math.random() * starRadius * 2 - starRadius,
                Math.random() * starRadius * 2 - starRadius]
        });
    }

    function drawLandscape(r, c) {
        // Draw landscape "r" in color "c"

        let heightMult = 1;
        if (r < 4) {
            heightMult /= (4-r);
        }
        noStroke();
        fill(...c);
        beginShape();
        vertex(0, windowHeight);
        vertex(40, windowHeight - (heightMult * globalData[r][0].elevation / 10));
        let j = 0;
        globalData[r].forEach((i, j) => {
            vertex(
                2*40 + j * 20,
                windowHeight - (heightMult * i.elevation / 10)
            );
            jj = j;
        });
        vertex(10000 + windowWidth, windowHeight);
        endShape(CLOSE);
        ellipse(10, 10, 10, 10);
    }

    let frame = 300;

    function draw() {
        if (!dataReady) { return; }

        push();
        translate(3*windowWidth /4, windowHeight/6)
        rotate(-frame / 10000);
        starPositions.forEach(pos => {
            fill(205 + (random() * 50), 240, 240);
            ellipse(pos[0], pos[1], 2.5, 2.5);
        })
        pop();
        frame += 2;
        background(0, 50);

        for (let i = globalData.length - 1; i >= 0; i--) {
            let xOffset = -frame / (i + 1);
            while (xOffset < -(10000 + windowWidth)) {
                xOffset += (10000 + 2*windowWidth);
            }
            push();  // Start a new drawing state
            translate(xOffset, 0);
            drawLandscape(i, [255 - i * 40, 200, 200]);
            pop();
        }

    }
    </script>
</head>
<body>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-44566813-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>
